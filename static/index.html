<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recipe Manager</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>
<body>
    <div class="header">
        <a href="/" class="logo">Recipe Manager</a>
    </div>

    <div class="nav-container">
        <a href="/static/add.html" class="nav-button">レシピ追加</a>
        <a href="/static/search.html" class="nav-button">レシピ検索</a>
        <a href="/static/AIrecipe.html" class="nav-button">AIレシピ</a>
    </div>
    <div id="app">
        <h1>レシピ一覧</h1>

        <div class="container search-results">
            <!-- ローディング表示 -->
            <p v-if="loading">レシピを読み込んでいます...</p>
            
            <!-- エラー表示 -->
            <p v-if="error">{{ error }}</p>

            <!-- レシピ一覧 -->
            <div v-if="!loading && !error">
                <p v-if="recipes.length === 0">
                    登録されているレシピはまだありません。「レシピ追加」から最初のレシピを登録してみましょう！
                </p>
                <ul v-else>
                    <li v-for="(recipe, index) in recipes" :key="recipe.id || index">
                        <h3>{{ recipe.recipe_name }}</h3>
                        <button v-if="recipe.id" @click="deleteRecipe(recipe.id, index)" class="delete-button" title="削除">×</button>
                        <h4>材料:</h4>
                        <p v-html="formatText(recipe.ingredients)"></p>
                        <h4>作り方:</h4>
                        <p v-html="formatText(recipe.instructions)"></p>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    recipes: [],
                    loading: true,
                    error: null
                };
            },
            methods: {
                formatText(text) {
                    return (text || '').replace(/\n/g, '<br>');
                },
                async deleteRecipe(recipeId, index) {
                    if (!confirm('このレシピを本当に削除しますか？')) {
                        return;
                    }
                    try {
                        const response = await fetch(`/api/recipes/${recipeId}`, {
                            method: 'DELETE'
                        });
                        if (!response.ok) {
                            throw new Error('削除に失敗しました。');
                        }
                        // 画面のリストからレシピを削除
                        this.recipes.splice(index, 1);
                    } catch (e) {
                        alert(e.message);
                    }
                }
            },
            async mounted() {
                try {
                    const response = await fetch('/api/recipes');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    this.recipes = data.reverse();
                } catch (e) {
                    console.error('レシピの取得に失敗しました:', e);
                    this.error = 'レシピの読み込み中にエラーが発生しました。';
                } finally {
                    this.loading = false;
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
